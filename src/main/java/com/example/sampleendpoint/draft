package com.example.sampleendpoint;


import com.ca.sql.DataSourceOptions;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import com.ca.sql.DataSources;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;



import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.*;


//@Path("/database-access")
public class DatabaseAccess {
    private static DataSource SqlDataSource;
    String host;
    String database;
    String username;
    String table;

    String Account;


    DatabaseAccess(String host, String database, String username, String table) throws SQLException {
        this.host = host;
        this.database = database;
        this.username = username;
        this.table = table;


    }
    public Map<String,Integer> EstablishConnection(Set<Integer> accountids) throws SQLException {
        Map<String,Integer> data = new HashMap<>();


        SqlDataSource = DataSources.fetch(host, database , username, DataSources.SqlDriver.MICROSOFT_MSSQL);


        //@GET
        //@Produces("text/plain")


        if (SqlDataSource == null)
            //return "Connection Failed";
            return null;
       /* else{
            System.out.println("Connection to "+ lmDataSource.getConnection() + " has been established");
        }*/
        else {
            Connection m_Connection = SqlDataSource.getConnection();
            Statement m_Statement = m_Connection.createStatement();
            String query = "";

            for(int account : accountids) {
                query = "select AccountID, count(ID) as Count from (Select   AccountID, ID from " + table + " where AccountID =" + account +") a group by  AccountID"; //="+ AccountID;
                ResultSet m_ResultSet = m_Statement.executeQuery(query);
                while (m_ResultSet.next()) {
                    data.put(m_ResultSet.getString("AccountID"), m_ResultSet.getInt("Count"));
                }
                System.out.println("Transaction Module Running for account" + account);
            }
            }


            /*ResultSet m_ResultSet = m_Statement.executeQuery(query);

            while (m_ResultSet.next()) {
                //System.out.println("why are we not receiving any output suddenly");
                //System.out.println(m_ResultSet.getString(1) + ", " + m_ResultSet.getString(2) + ", "+ m_ResultSet.getString(3));
                data.put(m_ResultSet.getString("AccountID"),m_ResultSet.getInt("Count")) ;


            }*/

        //return "Connection to " + SqlDataSource + " has been established";
        return data;


    }
}